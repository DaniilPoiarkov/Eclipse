# Eclipse

- [Take an action](#take-an-action)
- [Getting started](#getting-started)
  - [Build solution in docker](#build-solution-in-docker)
- [Diagrams](#diagrams)
  - [Infrastructure](#infrastructure)
  - [Outbox and Inbox messages processing](#outbox-and-inbox-messages-processing)
  - [Authorization flow](#authorization-flow)
  - [Pipeline concept](#pipeline-concept)
  - [Assembly references](#assembly-references)
- [Assemblies](#assemblies)
  - [General](#general)
  - [Core](#core)
  - [Pipelines](#pipelines)
  - [Localization](#localization)
- [Tests](#tests)
- [Integrations](#integrations)
- [Tech stack](#tech-stack)
- [Deployment and CICD](#deployment-and-cicd)

## Take an action
Open the Eclipse https://t.me/eclipse_app_bot!

Press `/start` button and choose a language you want to use, you'll be able to change it at any time!

Navigate to `Settings ‚öôÔ∏è` menu and set your time. Your account is now configured! Here you can change the language as well in case you missclicked at the begninning.)

On `Actions üñãÔ∏è` you can whether add some todo itemsüìù or schedule a reminderüí≠!

On evenings you'll receive the questionnaire with request to rate your mood. Do not hesitate to answer. After a few days you'll be able to visualize it in `Reports üìë` menu! Moreover, every sunday evening Eclipse will send you report automatically!

On `Reports üìë` you can also find your `Statistics üìà` based on how much reminders you received and todo items finished!

In fewer words, go through menu and try everything by yourself!

## Getting started

### Build solution in docker
#### Requirements
* Docker
* Ngrok account
* .NET 9

#### Step by step
Go to <i>docker</i> directory, create here a copy of _docker-compose.override.yaml_ file with name _docker-compose.local.yaml_.

Follow instructions in this file to build the solution locally.

After entering all required values for your _docker-compose.local.yaml_ file run _.\build.ps1_ script.

It will take a few minutes to start web api as cosmosdb emulator takes a while to prepare itself for work.

Check _eclipse-webapi_ container logs.

Run _.\stop.ps1_ script to stop container. It will also remove the image.

## Diagrams
### Infrastructure
Service communication within _Azure_ done using _Managed Identity_.
![infrastructure-dependencies](https://github.com/user-attachments/assets/190e8ccb-92b3-4bb5-94e2-fa109f3fb665)

### Outbox and Inbox messages processing
![outbox-and-inbox-processing](https://github.com/user-attachments/assets/36f4b4f2-d04e-4d20-b3cf-fd35d7cb94a2)

## Authorization flow
Works as MFA-like flow, where instead of password user uses short-lived autogenerated sign in code.
![eclipse-authorization-flow-png](https://github.com/user-attachments/assets/cfce1a24-7c18-4ea3-b696-f424582eab2c)

## Pipeline concept
This diagram shows how pipeline concept works and how user message proccedes:
![eclipse-pipeline-flow-png](https://github.com/user-attachments/assets/523d3fb7-ece8-4972-9b0c-40b7baa77d89)

## Assembly references
![Eclipse-Project references drawio](https://github.com/DaniilPoiarkov/Eclipse/assets/101814817/8c32847f-ecaf-4927-9e24-de2210a353b0)

## Assemblies

### General
Basically solution follows Clean Architecture. **WebAPI** is a presentation layer. **Application** and **Application.Contracts** represents use-cases splitted into different assemblies where the first  contains implementations and the last one defines public api. **Domain** and **Domain.Shared** represents the domain of the application, where the last one contains some domain specific definitions such as enums, constant values etc, which can be shared throughout whole solution. **Infrastructure**, as probably expected, contains implementations of logic-agnostic abstractions, like cache, background job manager etc. **DataAccess** responsibility is data persistance and defined in **Domain** repositories implementations. **Common** contains general extension methods and application-agnostic abstractions.

Nevertheless there're some assemblies which worth to mention separatelly.

### Core
In general represents some sort of mini-framework for building multiple-actions pipelines which requires user interaction with bunch of additional setup.

### Pipelines
Contain logic with telegram interaction. In other words it is available for end user functionality. This assembly uses **Core** for building new features.

### Localization
Built on top of __Microsoft.Extensions.Localization__ custom engine to work with json files as resource source with bunch of useful stuff.
Additionally provides an api which allows you to use another culture in disposable scope.

## Tests
Each Test project reference base **Eclipse.Tests** assembly, that provides helpers which used through all tests.

Each module has own test project.

BDD tests written with SpecFlow are all in the single tests assembly.

Integration tests also isolated in separate assembly called **Eclipse.IntegrationTests**.

## Integrations

### API
* Google API
* Telegram API

### Tech stack
* ASP.NET 9
* Quartz
* Azure CosmosDb
* Polly
* Scrutor
* Serilog
* EFCore
* Redis
* Azure Application Insights
* MiniExcel
* ScottPlot
* Docker

### Testing
* NSubstitute
* XUnit
* FluentAssertions (version 7.0.0, planned switching to _Shouldly_)
* Bogus
* Meziantou
* SpecFlow
* Testcontainers

## Deployment and CICD
* GitHub actions
* Azure App Service

### PR policy
Includes build, test, and generate result and coverage reports steps, which will be attached as a comments by _github-actions bot_.

### Merge
Includes build, test, build docker image, and deploy to Azure App Service jobs.
Uses _Service Principal_ for deployment with RBAC access.
