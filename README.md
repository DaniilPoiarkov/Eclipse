# Eclipse

- [Getting started](#getting-started)
- [Architecture diagram](#architecture-diagram)
- [Authorization flow](#authorization-flow)
- [Modules](#modules)
- [Tests](#tests)
- [Integrations](#integrations)
- [Tech stack](#tech-stack)
- [Deployment and CICD](#deployment-and-cicd)

## Getting started

### Requirements
* Docker
* ngrok
* .NET 9

<p>Go to <i>docker</i> directory, create here a copy of <i>docker-compose.override.yaml</i> file with name <i>docker-compose.local.yaml</i>.</p>
<p>Follow instructions in this file to build the solution locally.</p>
<p>After entering all required values for your <i>docker-compose.local.yaml</i> file run <i>.\build.ps1</i> script.</p>
<p>It will take a few minutes to start web api as cosmosdb emulator takes a while to prepare itself for work.</p>
<p>Check <i>eclipse-webapi</i> container logs.</p>
<p>Run <i>.\stop.ps1</i> script to stop container. It will also remove image.</p>

## Architecture diagram
### High level
![Eclipse](https://github.com/user-attachments/assets/06b1b2a7-41dc-4bec-92eb-6569a95d8283)

### Outbox and Inbox messages processing
![outbox-and-inbox-processing](https://github.com/user-attachments/assets/36f4b4f2-d04e-4d20-b3cf-fd35d7cb94a2)

## References
![Eclipse-Project references drawio](https://github.com/DaniilPoiarkov/Eclipse/assets/101814817/8c32847f-ecaf-4927-9e24-de2210a353b0)

## Authorization flow
Works as MFA-like flow, where instead of password user uses short-lived autogenerated sign in code.
![eclipse-authorization-flow-png](https://github.com/user-attachments/assets/cfce1a24-7c18-4ea3-b696-f424582eab2c)

## Modules

### WebAPI
Basicly controllers and health-checks.

### Pipelines
Contain logic with telegram interaction. In other words it is available for end user functionality.

This diagram shows how pipeline concept works and how user message proccedes:
![eclipse-pipeline-flow-png](https://github.com/user-attachments/assets/523d3fb7-ece8-4972-9b0c-40b7baa77d89)

### Application.Contracts
Provides public API for application use cases.

### Application
Contains implementations of use cases.

### Domain.Shared
Contains domain constants (like enums, const values) that can be shared thoughout whole solution.

### Domain
Contains domain logic of application.

### Core
Provides easy API to build and retrieve pipelines.

### Localization
Built on top of __Microsoft.Extensions.Localization__ engine to work with json files as resource source with bunch of useful stuff.
Additionally provides an api which allows you to use another culture in disposable scope.

### Infrastructure
Basicly contains wrappers with only necessary API and cross-cutting concerns.

### DataAccess
Data persistence with EF Core Cosmos Db provider.

## Tests
<p>Each Test project reference base Eclipse.Tests class library, that provides helpers which used through all tests.</p>
<p>Each module has own test project.</p>
<p>BDD tests written with SpecFlow are all in the single tests assembly.</p>
<p>Integration tests also isolated in separate assembly called <i>Eclipse.IntegrationTests</i>.</p>

## Integrations
### API
* Google API
* Telegram API

### Tech stack
* ASP.NET 9
* Quartz
* Azure CosmosDb
* Polly
* Scrutor
* Serilog
* EFCore
* Redis
* Azure Application Insights
* MiniExcel
* ScottPlot
* Docker

### Testing
* NSubstitute
* XUnit
* FluentAssertions
* Bogus
* Meziantou
* SpecFlow
* Testcontainers

## Deployment and CICD
* GitHub actions
* Azure AppServices

<p>Includes build, test, and creating coverage report using reportgenerator.</p>
<p>Results are added as a comment by <i>github-actions bot</i> to PR.</p>
<p>Uses <i>Service Principal</i> for deployment with RBAC access.</p>
